<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Pathfinder Test UI</title>
  <style>
    body {
      background: #1e1e1e;
      color: #eee;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin: 20px 0 10px;
      font-weight: 600;
    }
    canvas {
      background: #2a2a2a;
      border: 2px solid #444;
      margin-bottom: 10px;
      image-rendering: pixelated;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-bottom: 15px;
      max-width: 720px;
    }
    button, select, input[type="range"], input[type="number"] {
      background: #333;
      color: #eee;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    button:hover, select:hover, input[type="range"]:hover, input[type="number"]:hover {
      background: #555;
    }
    button:active {
      background: #777;
    }
    .labelled {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #ddd;
      font-size: 14px;
      user-select: none;
    }
    .log {
      width: 720px;
      max-height: 140px;
      background: #222;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 10px;
      font-family: monospace;
      font-size: 13px;
      overflow-y: auto;
      white-space: pre-wrap;
      color: #ccc;
      box-sizing: border-box;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Pathfinder UI ‚Äî –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø—É—Ç–∏</h1>
  <canvas id="grid-canvas" width="480" height="480" style="width:480px; height:480px;"></canvas>
  
  <div class="toolbar">
    <button id="wallBtn" title="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –°—Ç–µ–Ω–∞">üß± –°—Ç–µ–Ω–∞</button>
    <button id="startBtn" title="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –ù–∞—á–∞–ª–æ">üü¢ –°—Ç–∞—Ä—Ç</button>
    <button id="goalBtn" title="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –§–∏–Ω–∏—à">üî¥ –§–∏–Ω–∏—à</button>
    <button id="resetBtn" title="–°–±—Ä–æ—Å —Å–µ—Ç–∫–∏ –∏ —Å–ø–∞–≤–Ω–æ–≤">‚ôªÔ∏è –°–±—Ä–æ—Å</button>
    <button id="start-move" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤">‚ñ∂Ô∏è –ü—É—Å–∫</button>
    
    <div class="labelled" style="min-width: 190px;">
      <label for="speedRange">–°–∫–æ—Ä–æ—Å—Ç—å:</label>
      <input type="range" id="speedRange" min="1" max="10" value="5" />
      <input type="number" id="speedInput" min="1" max="10" value="5" style="width: 48px;" />
    </div>
    
    <div class="labelled" style="min-width: 160px;">
      <label for="moveMode">–†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:</label>
      <select id="moveMode">
        <option value="4">4 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</option>
        <option value="8">8 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</option>
      </select>
    </div>
  </div>
  
  <div id="log" class="log" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    import {
      selectTool,
      updateSpeed,
      updateMoveMode,
      resetGrid,
      draw,
      startOrders,
      addSpawner,
      setPathForSpawner,
      updateGrid,
      getPathForSpawner
    } from './test-pathfinder.js';

    const logElem = document.getElementById('log');
    const canvas = document.getElementById('grid-canvas');
    const ctx = canvas.getContext('2d');

    const gridWidth = 15;
    const gridHeight = 15;
    const cellSize = 32;

    let currentSpawnerId = 1;
    let movementMode = 4;
    let speed = 5;
    let selectedToolName = 'wall';
    let goal = { x: 14, y: 7 };
    let spawnersUI = {};

    function log(message) {
      const time = new Date().toLocaleTimeString();
      logElem.textContent += `[${time}] ${message}\n`;
      logElem.scrollTop = logElem.scrollHeight;
      console.info(message);
    }

    function getRandomColor() {
      const colors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#6f42c1'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function onSpeedChange(value) {
      speed = Math.max(1, Math.min(10, parseInt(value)));
      document.getElementById('speedRange').value = speed;
      document.getElementById('speedInput').value = speed;
      updateSpeed(speed);
      log(`–°–∫–æ—Ä–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${speed}`);
    }

    function onMoveModeChange() {
      const modeSelect = document.getElementById('moveMode');
      movementMode = parseInt(modeSelect.value);
      updateMoveMode();
      log(`–†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${movementMode} –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π`);
      const useDiagonal = (movementMode === 8);
      for (const id in spawnersUI) {
        setPathForSpawner(id, spawnersUI[id].pos, goal, useDiagonal);
      }
      draw();
    }

    function redraw() {
      draw();
    }

    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / cellSize);
      const y = Math.floor((e.clientY - rect.top) / cellSize);
      if (x < 0 || y < 0 || x >= gridWidth || y >= gridHeight) return;
      switch (selectedToolName) {
        case 'wall': toggleWallAt(x, y); break;
        case 'goal':
          goal = { x, y };
          log(`–ù–æ–≤–∞—è —Ç–æ—á–∫–∞ —Ñ–∏–Ω–∏—à–∞: (${x},${y})`);
          break;
        case 'start': addNewSpawner(x, y); break;
      }
      updateGridState();
      redraw();
    });

    function toggleWallAt(x, y) {
      if (!window._grid) {
        window._grid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(0));
      }
      window._grid[y][x] = window._grid[y][x] === 1 ? 0 : 1;
      updateGrid(window._grid);
      log(`–°—Ç–µ–Ω–∞ ${window._grid[y][x] === 1 ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '—É–¥–∞–ª–µ–Ω–∞'} –≤ (${x},${y})`);
    }

    function addNewSpawner(x, y) {
      const id = `S${currentSpawnerId++}`;
      const color = getRandomColor();
      spawnersUI[id] = { pos: { x, y }, color };
      const useDiagonal = (movementMode === 8);
      addSpawner(id, { x, y }, goal, useDiagonal);
      log(`–°–ø–∞–≤–Ω "${id}" –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ (${x},${y})`);
    }

    function updateGridState() {
      const useDiagonal = (movementMode === 8);
      for (const id in spawnersUI) {
        setPathForSpawner(id, spawnersUI[id].pos, goal, useDiagonal);
      }
    }

    document.getElementById('wallBtn').onclick = () => {
      selectedToolName = 'wall';
      selectTool('wall');
      log('–í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –°—Ç–µ–Ω–∞');
    };
    document.getElementById('startBtn').onclick = () => {
      selectedToolName = 'start';
      selectTool('start');
      log('–í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –°—Ç–∞—Ä—Ç');
    };
    document.getElementById('goalBtn').onclick = () => {
      selectedToolName = 'goal';
      selectTool('goal');
      log('–í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –§–∏–Ω–∏—à');
    };
    document.getElementById('resetBtn').onclick = () => {
      resetGrid();
      window._grid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(0));
      spawnersUI = {};
      currentSpawnerId = 1;
      goal = { x: 14, y: 7 };
      log('–°–µ—Ç–∫–∞ –∏ —Å–ø–∞–≤–Ω—ã —Å–±—Ä–æ—à–µ–Ω—ã');
      redraw();
    };
    document.getElementById('start-move').onclick = () => {
      if (Object.keys(spawnersUI).length === 0) {
        log('–ù–µ—Ç —Å–ø–∞–≤–Ω–æ–≤ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è');
        return;
      }
      startOrders();
      log('–î–≤–∏–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
    };
    document.getElementById('speedRange').oninput = e => { onSpeedChange(e.target.value); };
    document.getElementById('speedInput').onchange = e => { onSpeedChange(e.target.value); };
    document.getElementById('moveMode').onchange = () => { onMoveModeChange(); };

    (function init() {
      window._grid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(0));
      resetGrid();
      redraw();
      log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É.');

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      (function verifyFunctions() {
        if (typeof selectTool !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `selectTool()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `selectTool()` –≥–æ—Ç–æ–≤–∞");
        if (typeof updateSpeed !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `updateSpeed()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `updateSpeed()` –≥–æ—Ç–æ–≤–∞");
        if (typeof updateMoveMode !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `updateMoveMode()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `updateMoveMode()` –≥–æ—Ç–æ–≤–∞");
        if (typeof resetGrid !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `resetGrid()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `resetGrid()` –≥–æ—Ç–æ–≤–∞");
        if (typeof draw !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `draw()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `draw()` –≥–æ—Ç–æ–≤–∞");
        if (typeof startOrders !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `startOrders()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `startOrders()` –≥–æ—Ç–æ–≤–∞");
        if (typeof addSpawner !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `addSpawner()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `addSpawner()` –≥–æ—Ç–æ–≤–∞");
        if (typeof setPathForSpawner !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `setPathForSpawner()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `setPathForSpawner()` –≥–æ—Ç–æ–≤–∞");
        if (typeof updateGrid !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `updateGrid()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `updateGrid()` –≥–æ—Ç–æ–≤–∞");
        if (typeof getPathForSpawner !== 'function') log("[‚ùå] –§—É–Ω–∫—Ü–∏—è `getPathForSpawner()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"); else log("[‚úÖ] `getPathForSpawner()` –≥–æ—Ç–æ–≤–∞");
      })();
    })();
  </script>
</body>
</html>
