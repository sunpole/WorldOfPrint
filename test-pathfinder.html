<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Pathfinder Test</title>
  <style>
    body { background: #111; color: white; font-family: sans-serif; margin: 0; padding: 0; }
    canvas { display: block; margin: 20px auto; background: #222; border: 1px solid #666; }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin: 10px auto;
      max-width: 800px;
    }
    .toolbar > * {
      margin: 4px;
    }
    button, select, input[type="number"] {
      padding: 6px;
      font-size: 14px;
      background: #333;
      color: white;
      border: 1px solid #666;
      border-radius: 4px;
      cursor: pointer;
    }
    .labelled {
      display: flex;
      align-items: center;
      gap: 4px;
      color: white;
    }
    .log {
      max-width: 800px;
      margin: 0 auto;
      background: #1a1a1a;
      padding: 10px;
      font-size: 12px;
      height: 100px;
      overflow-y: auto;
      border-top: 1px solid #333;
      white-space: pre-wrap;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2 align="center">üß≠ Pathfinder UI –¢–µ—Å—Ç</h2>
  <canvas id="grid-canvas" width="480" height="480"></canvas>

  <div class="toolbar">
    <button id="wallBtn">üß± –°—Ç–µ–Ω–∞</button>
    <button id="startBtn">üü¢ –°—Ç–∞—Ä—Ç</button>
    <button id="goalBtn">üî¥ –§–∏–Ω–∏—à</button>
    <button id="addSpawnerBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ø–∞–≤–Ω</button>
    <button id="resetBtn">‚ôªÔ∏è –°–±—Ä–æ—Å</button>
    <button id="start-move">‚ñ∂Ô∏è –ü—É—Å–∫</button>

    <div class="labelled">
      <label for="speedRange">–°–∫–æ—Ä–æ—Å—Ç—å:</label>
      <input type="range" id="speedRange" min="1" max="10" value="5" />
      <input type="number" id="speedInput" min="1" max="10" value="5" />
    </div>

    <div class="labelled">
      <label for="moveMode">–†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:</label>
      <select id="moveMode">
        <option value="4">4 —Å—Ç–æ—Ä–æ–Ω—ã</option>
        <option value="8">8 —Å—Ç–æ—Ä–æ–Ω</option>
      </select>
    </div>
  </div>

  <div class="log" id="log"></div>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å test-pathfinder.js, –æ–Ω —Å–∞–º –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç pathfinder.js -->
  <script type="module">
    import {
      selectTool,
      updateSpeed,
      updateMoveMode,
      resetGrid,
      draw,
      startOrders,
      addSpawner,
      setPathForSpawner,
      updateGrid,
      getPathForSpawner
    } from './test-pathfinder.js';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const logElem = document.getElementById('log');
    const canvas = document.getElementById('grid-canvas');
    const ctx = canvas.getContext('2d');

    let currentSpawnerId = 1;
    let movementMode = 4; // 4 –∏–ª–∏ 8
    let speed = 5;
    let selectedToolName = 'wall';
    let goal = { x: 14, y: 7 };
    let gridWidth = 15;
    let gridHeight = 15;
    const cellSize = 32;

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Å–ø–∞–≤–Ω–æ–≤ –≤ UI (—Å —Ü–≤–µ—Ç–æ–º)
    let spawnersUI = {}; // {id: {pos: {x,y}, color}}

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ div
    function log(message) {
      const time = new Date().toLocaleTimeString();
      logElem.textContent += `[${time}] ${message}\n`;
      logElem.scrollTop = logElem.scrollHeight;
      console.info(message);
    }

    // –¶–≤–µ—Ç–∞ –¥–ª—è —Å–ø–∞–≤–Ω–æ–≤
    function getRandomColor() {
      const colors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#6f42c1'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–∑ UI –∏ –º–æ–¥—É–ª—è
    function onSpeedChange(value) {
      speed = Math.max(1, Math.min(10, parseInt(value)));
      document.getElementById('speedRange').value = speed;
      document.getElementById('speedInput').value = speed;
      updateSpeed(speed);
      log(`–°–∫–æ—Ä–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${speed}`);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏–∑ UI
    function onMoveModeChange() {
      const modeSelect = document.getElementById('moveMode');
      movementMode = parseInt(modeSelect.value);
      updateMoveMode();
      log(`–†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${movementMode} –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π`);

      // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø—É—Ç–∏ –¥–ª—è –≤—Å–µ—Ö —Å–ø–∞–≤–Ω–æ–≤ —Å –Ω–æ–≤—ã–º —Ä–µ–∂–∏–º–æ–º
      const useDiagonal = (movementMode === 8);
      for (const id in spawnersUI) {
        setPathForSpawner(id, spawnersUI[id].pos, goal, useDiagonal);
      }
      draw();
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π draw
    function redraw() {
      draw();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ canvas –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / cellSize);
      const y = Math.floor((e.clientY - rect.top) / cellSize);

      if (x < 0 || y < 0 || x >= gridWidth || y >= gridHeight) return;

      switch (selectedToolName) {
        case 'wall':
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å—Ç–µ–Ω—É
          toggleWallAt(x, y);
          break;
        case 'goal':
          goal = { x, y };
          log(`–ù–æ–≤–∞—è —Ç–æ—á–∫–∞ —Ñ–∏–Ω–∏—à–∞: (${x},${y})`);
          break;
        case 'start':
          addNewSpawner(x, y);
          break;
      }

      updateGridState();
      redraw();
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç–µ–Ω—É –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
    function toggleWallAt(x, y) {
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π grid, –º–µ–Ω—è–µ–º –∫–ª–µ—Ç–∫—É —Å 0 –Ω–∞ 1 –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
      // –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–∑–æ–≤–µ–º updateGrid —Å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–º –º–∞—Å—Å–∏–≤–æ–º –∏–∑ test-pathfinder.js
      // –ù–æ —É –Ω–∞—Å grid –≤ test-pathfinder.js –ø—Ä–∏–≤–∞—Ç–Ω—ã–π, –ø–æ—ç—Ç–æ–º—É –±—É–¥–µ–º —á–µ—Ä–µ–∑ setPathForSpawner –∏ updateGrid
      // –í —Ç–≤–æ—ë–º —Ç–µ—Å—Ç–æ–≤–æ–º –º–æ–¥—É–ª–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —ç–∫—Å–ø–æ—Ä—Ç updateGrid –∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è grid ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º updateGrid
      // –ù–æ —É —Ç–µ–±—è grid –ª–æ–∫–∞–ª—å–Ω—ã–π –≤ test-pathfinder.js ‚Äî –∑–¥–µ—Å—å —Ö—Ä–∞–Ω–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ?

      // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã ‚Äî —Å–¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ –∏–∑ UI
      // –°–æ–∑–¥–∞–¥–∏–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é —Å–µ—Ç–∫–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º)

      // –ü–æ–∫–∞ —Ö—Ä–∞–Ω–∏–º —Å–µ—Ç–∫—É –≤ UI –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –º–æ–¥—É–ª–µ–º:
      if (!window._grid) {
        window._grid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(0));
      }
      window._grid[y][x] = window._grid[y][x] === 1 ? 0 : 1;
      updateGrid(window._grid);
      log(`–°—Ç–µ–Ω–∞ ${window._grid[y][x] === 1 ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '—É–¥–∞–ª–µ–Ω–∞'} –≤ (${x},${y})`);
    }

    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–ø–∞–≤–Ω
    function addNewSpawner(x, y) {
      const id = `S${currentSpawnerId++}`;
      const color = getRandomColor();
      spawnersUI[id] = { pos: { x, y }, color };
      const useDiagonal = (movementMode === 8);
      addSpawner(id, { x, y }, goal, useDiagonal);
      log(`–°–ø–∞–≤–Ω "${id}" –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ (${x},${y})`);
    }

    // –û–±–Ω–æ–≤–∏—Ç—å grid –≤ –º–æ–¥—É–ª–µ
    function updateGridState() {
      // –û–±–Ω–æ–≤–∏–º –ø—É—Ç–∏ –¥–ª—è –≤—Å–µ—Ö —Å–ø–∞–≤–Ω–æ–≤
      const useDiagonal = (movementMode === 8);
      for (const id in spawnersUI) {
        setPathForSpawner(id, spawnersUI[id].pos, goal, useDiagonal);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    document.getElementById('wallBtn').onclick = () => {
      selectedToolName = 'wall';
      selectTool('wall');
      log('–í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –°—Ç–µ–Ω–∞');
    };
    document.getElementById('startBtn').onclick = () => {
      selectedToolName = 'start';
      selectTool('start');
      log('–í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –°—Ç–∞—Ä—Ç');
    };
    document.getElementById('goalBtn').onclick = () => {
      selectedToolName = 'goal';
      selectTool('goal');
      log('–í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –§–∏–Ω–∏—à');
    };

    // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
    document.getElementById('resetBtn').onclick = () => {
      resetGrid();
      window._grid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(0));
      spawnersUI = {};
      currentSpawnerId = 1;
      goal = { x: 14, y: 7 };
      log('–°–µ—Ç–∫–∞ –∏ —Å–ø–∞–≤–Ω—ã —Å–±—Ä–æ—à–µ–Ω—ã');
      redraw();
    };

    // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è
    document.getElementById('start-move').onclick = () => {
      if (Object.keys(spawnersUI).length === 0) {
        log('–ù–µ—Ç —Å–ø–∞–≤–Ω–æ–≤ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è');
        return;
      }
      startOrders();
      log('–î–≤–∏–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
    };

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª–∑—É–Ω–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
    document.getElementById('speedRange').oninput = e => {
      onSpeedChange(e.target.value);
    };
    document.getElementById('speedInput').onchange = e => {
      onSpeedChange(e.target.value);
    };

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    document.getElementById('moveMode').onchange = () => {
      onMoveModeChange();
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    (function init() {
      window._grid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(0));
      resetGrid();
      redraw();
      log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É.');
    })();
  </script>
</body>
</html>
